
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the Agentic-AI framework">
      
      
        <meta name="author" content="Agentic-AI Team">
      
      
        <link rel="canonical" href="https://0x00000002.github.io/agentic-ai/future_development/">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>Enhanced Development Plan: Personal AI Assistant Framework - Agentic-AI Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4af4bdda.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#enhanced-development-plan-personal-ai-assistant-framework" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Agentic-AI Documentation" class="md-header__button md-logo" aria-label="Agentic-AI Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Agentic-AI Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Enhanced Development Plan: Personal AI Assistant Framework
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/0x00000002/agentic-ai" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../getting-started/" class="md-tabs__link">
        
  
  
    
  
  Getting Started

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../architecture/" class="md-tabs__link">
        
  
  
    
  
  Architecture

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../core/" class="md-tabs__link">
          
  
  
  Core Concepts

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../tools/overview/" class="md-tabs__link">
          
  
  
  Tools & MCP

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../utils/" class="md-tabs__link">
          
  
  
  Utilities

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../providers/overview/" class="md-tabs__link">
          
  
  
  Models

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../examples/" class="md-tabs__link">
          
  
  
  Examples

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Agentic-AI Documentation" class="md-nav__button md-logo" aria-label="Agentic-AI Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Agentic-AI Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/0x00000002/agentic-ai" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Core Concepts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Core Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core AI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agents
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../conversations/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Conversations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../error_handling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Error Handling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configuration_system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tools & MCP
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Tools & MCP
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/image_generator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Image Generation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/mcp_tool_usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Using MCP Tools
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/tool_stats_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tool Statistics
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Utilities
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Utilities
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Logging & Utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prompt_templates/management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prompt Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prompt_templates/guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prompting Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../metrics_system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metrics System
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Models
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../providers/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/configuration_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ui/gradio_interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    UI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_4" >
        
          
          <label class="md-nav__link" for="__nav_8_4" id="__nav_8_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_4">
            <span class="md-nav__icon md-icon"></span>
            Testing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/testing_providers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing Providers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/testing_strategy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing Strategy
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="enhanced-development-plan-personal-ai-assistant-framework">Enhanced Development Plan: Personal AI Assistant Framework</h1>
<p>This document enhances the original development plan with specific technical details and considerations for the Agentic-AI framework. The plan maintains the original phases while adding guidance and strategic considerations to make it more actionable.</p>
<h2 id="phase-1-core-framework-persistence-layer">Phase 1: Core Framework - Persistence Layer</h2>
<h3 id="1-conversationstore-interface-design">1. ConversationStore Interface Design</h3>
<ul>
<li>
<p><strong>Design Recommendations</strong>:</p>
</li>
<li>
<p>Create a clean async interface with methods: <code>load_conversation</code>, <code>save_conversation</code>, <code>delete_conversation</code>, and <code>list_conversations</code></p>
</li>
<li>Include proper error handling via custom exceptions (e.g., <code>ConversationError</code>)</li>
<li>Add pagination support for listing conversations (limit/offset parameters)</li>
<li>
<p>Include clear documentation for each method with types and error expectations</p>
</li>
<li>
<p><strong>Interface Extension Considerations</strong>:</p>
</li>
<li>Consider adding optional metadata methods for conversation stats or user preferences</li>
<li>Plan for future extensions like conversation search or tagging</li>
<li>Add a method for data export/import to facilitate migrations</li>
</ul>
<h3 id="2-fileconversationstore-implementation">2. FileConversationStore Implementation</h3>
<ul>
<li>
<p><strong>Key Features</strong>:</p>
</li>
<li>
<p>Use <code>aiofiles</code> for non-blocking I/O operations</p>
</li>
<li>Implement path sanitization to prevent directory traversal</li>
<li>Create a directory structure that scales well with many conversations</li>
<li>Add file locking mechanism to prevent concurrent write issues</li>
<li>
<p>Implement automatic cleanup of old/inactive conversations</p>
</li>
<li>
<p><strong>Performance Considerations</strong>:</p>
</li>
<li>Consider implementing an in-memory cache for frequently accessed conversations</li>
<li>Add configurable compression for large conversations</li>
<li>Implement chunking for very large conversations to avoid memory issues</li>
</ul>
<h3 id="3-dynamodbconversationstore-implementation">3. DynamoDBConversationStore Implementation</h3>
<ul>
<li>
<p><strong>Core Implementation</strong>:</p>
</li>
<li>
<p>Utilize the <code>boto3</code> library for AWS DynamoDB integration</p>
</li>
<li>Handle the 400KB DynamoDB item size limit through automatic compression</li>
<li>Create a robust schema with <code>conversation_id</code> as partition key</li>
<li>Add <code>last_updated</code> attribute for better sorting/filtering</li>
<li>
<p>Consider using TTL for automatic conversation expiration</p>
</li>
<li>
<p><strong>Advanced Features</strong>:</p>
</li>
<li>
<p>Implement efficient conversation listing with a GSI on <code>last_updated</code></p>
</li>
<li>Create intelligent splitting strategy for conversations exceeding size limits</li>
<li>Add automatic retry logic for DynamoDB throttling</li>
<li>
<p>Implement write batching for improved performance</p>
</li>
<li>
<p><strong>Cost Optimization</strong>:</p>
</li>
<li>Configure automatic scaling for DynamoDB based on usage patterns</li>
<li>Implement read/write unit monitoring and alerting</li>
<li>Consider using DynamoDB Accelerator (DAX) for high-traffic scenarios</li>
</ul>
<h3 id="4-conversationmanager-integration">4. ConversationManager Integration</h3>
<ul>
<li>
<p><strong>Integration Strategy</strong>:</p>
</li>
<li>
<p>Add <code>conversation_id</code> and <code>store</code> parameters to <code>ConversationManager.__init__()</code></p>
</li>
<li>Implement lazy loading of conversation data on first access</li>
<li>Update all message methods to be async for compatibility with storage layer</li>
<li>
<p>Add state tracking to minimize unnecessary saves</p>
</li>
<li>
<p><strong>Implementation Considerations</strong>:</p>
</li>
<li>
<p>Add a method to switch between storage implementations</p>
</li>
<li>Implement graceful fallbacks if persistent storage fails</li>
<li>Add message validation before storage</li>
<li>
<p>Implement conversation forking/merging capabilities</p>
</li>
<li>
<p><strong>Prompt for AI Implementation Assistant</strong>:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>You are an expert Python developer tasked with updating the ConversationManager class to support persistent storage. The class currently uses an in-memory list to store conversation messages.

Your task:
1. Modify the class to accept a ConversationStore implementation and conversation_id parameter
2. Convert relevant methods to be async to work with the async storage interface
3. Implement lazy loading to defer fetching conversation history until needed
4. Add efficient save logic to minimize storage operations
5. Ensure backward compatibility with existing code

Remember that the ConversationManager is used extensively throughout the codebase, particularly in ToolEnabledAI and BaseAgent, so changes must be non-disruptive to existing functionality.
</code></pre></div>
<h2 id="phase-2-tooling-telegram-integration">Phase 2: Tooling &amp; Telegram Integration</h2>
<h3 id="1-telegram-bot-integration">1. Telegram Bot Integration</h3>
<ul>
<li>
<p><strong>Bot Architecture</strong>:</p>
</li>
<li>
<p>Create a dedicated <code>TelegramBot</code> class that manages the Telegram interaction</p>
</li>
<li>Use <code>python-telegram-bot</code> library's application-based approach for modern async handling</li>
<li>Implement command handlers for <code>/start</code>, <code>/help</code>, and <code>/reset</code></li>
<li>Add conversation context tracking via Telegram's <code>chat_id</code></li>
<li>
<p>Create robust error handling with user-friendly messages</p>
</li>
<li>
<p><strong>Feature Considerations</strong>:</p>
</li>
<li>
<p>Implement typing indicators during processing for better UX</p>
</li>
<li>Add throttling/rate limiting for high-volume users</li>
<li>Implement proper shutdown handling for graceful termination</li>
<li>Consider keyboard shortcuts for common actions</li>
<li>
<p>Support for inline queries and message editing</p>
</li>
<li>
<p><strong>Voice Handling</strong>:</p>
</li>
<li>
<p>Implement audio file download and temporary storage</p>
</li>
<li>Add voice transcription via existing listener agent</li>
<li>Handle different audio formats and quality</li>
<li>
<p>Implement automatic cleanup of temporary files</p>
</li>
<li>
<p><strong>Prompt for AI Telegram Implementation Assistant</strong>:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>You are a Telegram bot implementation expert. Design a robust, production-ready Telegram bot for our AI assistant framework with these requirements:

1. Asynchronous handling of all Telegram interactions
2. Integration with our existing Coordinator agent as the central processing unit
3. Persistent conversation storage using our ConversationStore interface
4. Support for text and voice message processing
5. Error handling that&#39;s both robust and user-friendly
6. Clean separation between Telegram-specific logic and core AI functionality

Additionally, outline any security considerations and performance optimizations relevant to a Telegram bot deployment.
</code></pre></div>
<h3 id="2-mcp-tools-integration">2. MCP Tools Integration</h3>
<ul>
<li>
<p><strong>MCP Configuration</strong>:</p>
</li>
<li>
<p>Create a dedicated <code>MCPConfig</code> class to manage MCP configuration</p>
</li>
<li>Support loading configuration from YAML file or environment variables</li>
<li>Include proper validation of MCP endpoint configurations</li>
<li>
<p>Store connection details, authentication, and endpoint parameters</p>
</li>
<li>
<p><strong>MCP Tool Implementation</strong>:</p>
</li>
<li>
<p>Develop a generic <code>MCPTool</code> class that handles HTTP communication</p>
</li>
<li>Use <code>aiohttp</code> for non-blocking HTTP requests</li>
<li>Implement timeout handling with configurable defaults</li>
<li>Add retry logic for transient network issues</li>
<li>
<p>Create proper error handling and reporting</p>
</li>
<li>
<p><strong>Integration with Tool System</strong>:</p>
</li>
<li>
<p>Register MCP tools in the existing ToolManager system</p>
</li>
<li>Generate appropriate ToolDefinitions from MCP configuration</li>
<li>Map parameters correctly between AI model and MCP endpoints</li>
<li>
<p>Implement proper serialization/deserialization of values</p>
</li>
<li>
<p><strong>Configuration Example</strong>:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># mcp.yml example</span>
<span class="nt">tools</span><span class="p">:</span>
<span class="w">  </span><span class="nt">web_search</span><span class="p">:</span>
<span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://mcp-search-service.example.com/search&quot;</span>
<span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Search</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">web</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">information&quot;</span>
<span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">    </span><span class="nt">parameters</span><span class="p">:</span>
<span class="w">      </span><span class="nt">query</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;string&quot;</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;The</span><span class="nv"> </span><span class="s">search</span><span class="nv"> </span><span class="s">query&quot;</span>
<span class="w">      </span><span class="nt">limit</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;integer&quot;</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Maximum</span><span class="nv"> </span><span class="s">number</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">results&quot;</span>
<span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>

<span class="w">  </span><span class="nt">email_sender</span><span class="p">:</span>
<span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://mcp-email-service.example.com/send&quot;</span>
<span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Send</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">email</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">recipient&quot;</span>
<span class="w">    </span><span class="nt">requires_auth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15</span>
<span class="w">    </span><span class="nt">parameters</span><span class="p">:</span>
<span class="w">      </span><span class="nt">to</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;string&quot;</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Recipient&#39;s</span><span class="nv"> </span><span class="s">email</span><span class="nv"> </span><span class="s">address&quot;</span>
<span class="w">      </span><span class="nt">subject</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;string&quot;</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Email</span><span class="nv"> </span><span class="s">subject&quot;</span>
<span class="w">      </span><span class="nt">body</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;string&quot;</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Email</span><span class="nv"> </span><span class="s">body</span><span class="nv"> </span><span class="s">content&quot;</span>
</code></pre></div>
<h2 id="phase-3-deployment-operations-vm-focus">Phase 3: Deployment &amp; Operations (VM Focus)</h2>
<h3 id="1-vm-provisioning-configuration">1. VM Provisioning &amp; Configuration</h3>
<ul>
<li>
<p><strong>Provider Selection</strong>:</p>
</li>
<li>
<p>Recommend AWS Lightsail or DigitalOcean for simpler management</p>
</li>
<li>For EC2, use t3a.small (2vCPU, 2GB RAM) as a minimum configuration</li>
<li>Consider spot instances for cost optimization if appropriate</li>
<li>
<p>Set up automatic backup for the VM</p>
</li>
<li>
<p><strong>Base System Setup</strong>:</p>
</li>
<li>
<p>Use Ubuntu 22.04 LTS for long-term stability</p>
</li>
<li>Set up UFW firewall allowing only SSH and specific application ports</li>
<li>Implement automatic security updates</li>
<li>Configure proper swap space (at least 4GB)</li>
<li>
<p>Set up monitoring with CloudWatch or Prometheus</p>
</li>
<li>
<p><strong>Resource Sizing Guidelines</strong>:</p>
</li>
<li>RAM: Minimum 2GB, recommended 4GB for production use</li>
<li>Storage: 20GB SSD minimum, with separate volume for conversation data</li>
<li>CPU: 2 vCPU minimum for responsiveness</li>
<li>Network: Standard is sufficient, monitor bandwidth usage</li>
</ul>
<h3 id="2-dockerization-deployment">2. Dockerization &amp; Deployment</h3>
<ul>
<li>
<p><strong>Docker Image Design</strong>:</p>
</li>
<li>
<p>Use multi-stage builds to minimize image size</p>
</li>
<li>Base image: python:3.9-slim for smaller footprint</li>
<li>Create non-root user for security</li>
<li>Cache pip dependencies for faster builds</li>
<li>
<p>Include only necessary files and directories</p>
</li>
<li>
<p><strong>Docker Compose Configuration</strong>:</p>
</li>
<li>
<p>Create separate services for the main application, Nginx, and possibly Redis</p>
</li>
<li>Set up named volumes for persistent data</li>
<li>Configure environment-specific compose files</li>
<li>Set resource limits appropriately</li>
<li>
<p>Configure logging driver (json-file with rotation)</p>
</li>
<li>
<p><strong>Deployment Management</strong>:</p>
</li>
<li>
<p>Create simple deployment script for pull, build, up cycle</p>
</li>
<li>Implement health checks for all containers</li>
<li>Add monitoring endpoints (but secure them properly)</li>
<li>Set appropriate restart policies</li>
<li>
<p>Consider Watchtower for automatic image updates</p>
</li>
<li>
<p><strong>Prompt for AI Docker Implementation Assistant</strong>:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>You are a Docker and containerization expert. Create a production-ready Docker deployment strategy for our Python-based AI assistant with these requirements:

1. Efficient Dockerfile that minimizes image size and build time
2. Docker Compose configuration for coordinating multiple services
3. Proper volume management for persistent data
4. Security hardening for the containerized application
5. Resource allocation recommendations
6. Logging and monitoring strategy

The application is a Python 3.9 async application that uses significant RAM when processing requests but has low baseline resource usage when idle.
</code></pre></div>
<h3 id="3-security-monitoring">3. Security &amp; Monitoring</h3>
<ul>
<li>
<p><strong>Security Hardening</strong>:</p>
</li>
<li>
<p>Implement SSH key-only authentication</p>
</li>
<li>Use AWS IAM roles when possible instead of static credentials</li>
<li>Configure AWS Security Groups or VPC for network isolation</li>
<li>Regularly rotate all credentials</li>
<li>
<p>Enable CloudTrail for AWS API activity logging</p>
</li>
<li>
<p><strong>Monitoring Setup</strong>:</p>
</li>
<li>
<p>Set up CloudWatch for basic resource monitoring</p>
</li>
<li>Create custom CloudWatch metrics for application-specific metrics</li>
<li>Set alarms for memory, CPU, and disk usage</li>
<li>Implement log forwarding to CloudWatch Logs</li>
<li>
<p>Create a dashboard for quick system status overview</p>
</li>
<li>
<p><strong>Backup Strategy</strong>:</p>
</li>
<li>Daily backups of conversation data to S3</li>
<li>Implement backup rotation policy (keep 7 daily, 4 weekly)</li>
<li>Periodic backup verification</li>
<li>Document restore procedures and test them</li>
</ul>
<h3 id="4-operational-considerations">4. Operational Considerations</h3>
<ul>
<li>
<p><strong>Scaling Strategy</strong>:</p>
</li>
<li>
<p>Plan for vertical scaling path (larger VM) as primary approach</p>
</li>
<li>Document horizontal scaling options if needed later</li>
<li>
<p>Identify potential bottlenecks (e.g., token rate limits, database IOPS)</p>
</li>
<li>
<p><strong>Cost Management</strong>:</p>
</li>
<li>
<p>Set up budget alerts in AWS</p>
</li>
<li>Monitor DynamoDB usage carefully</li>
<li>Consider reserved instances for long-term cost savings</li>
<li>
<p>Implement auto-scaling to reduce costs during low-usage periods</p>
</li>
<li>
<p><strong>Maintenance Procedures</strong>:</p>
</li>
<li>Document update process for the application</li>
<li>Create runbooks for common operations</li>
<li>Establish maintenance window for regular updates</li>
<li>Implement blue-green deployment for zero-downtime updates</li>
</ul>
<h2 id="phase-4-future-enhancements-post-mvp">Phase 4: Future Enhancements (Post-MVP)</h2>
<h3 id="1-performance-optimizations">1. Performance Optimizations</h3>
<ul>
<li>
<p><strong>Caching Strategy</strong>:</p>
</li>
<li>
<p>Implement Redis for LLM response caching</p>
</li>
<li>Add cache warming for common queries</li>
<li>Create intelligent cache invalidation rules</li>
<li>
<p>Consider embedding caching for RAG operations</p>
</li>
<li>
<p><strong>Resource Optimization</strong>:</p>
</li>
<li>Implement auto-scaling based on time-of-day patterns</li>
<li>Add dynamic model selection based on query complexity</li>
<li>Optimize token usage through prompt engineering</li>
<li>Implement batching for tool operations when possible</li>
</ul>
<h3 id="2-advanced-capabilities">2. Advanced Capabilities</h3>
<ul>
<li>
<p><strong>Enhanced Agent Selection</strong>:</p>
</li>
<li>
<p>Develop more sophisticated agent routing logic</p>
</li>
<li>Implement specialized agents for vertical domains</li>
<li>Create agent collaboration patterns for complex tasks</li>
<li>
<p>Add reinforcement learning for improved agent selection</p>
</li>
<li>
<p><strong>Conversation Memory Improvements</strong>:</p>
</li>
<li>
<p>Implement semantic indexing of conversation history</p>
</li>
<li>Add long-term memory via RAG patterns</li>
<li>Create user preference learning capabilities</li>
<li>
<p>Implement conversation summarization for context management</p>
</li>
<li>
<p><strong>Tool Ecosystem Expansion</strong>:</p>
</li>
<li>
<p>Create tool discovery mechanism</p>
</li>
<li>Implement tool composition for complex operations</li>
<li>Add user-specific tool authorization</li>
<li>
<p>Create tool usage analytics for optimization</p>
</li>
<li>
<p><strong>Prompt for AI Advanced Features Assistant</strong>:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>You are a strategic AI product architect. Outline a detailed roadmap for advanced features that could be added to our personal AI assistant framework after the MVP. Focus on:

1. Conversation intelligence and memory management
2. Multi-agent collaboration patterns
3. Advanced tool composition and discovery
4. User personalization and adaptation
5. Performance optimizations at scale

For each feature area, describe the user value, technical approach, implementation complexity, and potential challenges. Prioritize features that would deliver the most immediate value while setting up for longer-term capabilities.
</code></pre></div>
<h3 id="3-admin-monitoring-dashboard">3. Admin &amp; Monitoring Dashboard</h3>
<ul>
<li>
<p><strong>Dashboard Design</strong>:</p>
</li>
<li>
<p>Create simple web-based admin interface</p>
</li>
<li>Add conversation search and browsing capabilities</li>
<li>Implement user management features</li>
<li>Add usage analytics and reporting</li>
<li>
<p>Create system health monitoring view</p>
</li>
<li>
<p><strong>Operational Metrics</strong>:</p>
</li>
<li>Track response times, token usage, and completion rates</li>
<li>Implement conversation quality metrics</li>
<li>Monitor tool usage patterns and success rates</li>
<li>Track error rates and patterns</li>
<li>Add cost allocation reporting</li>
</ul>
<h3 id="4-cicd-pipeline">4. CI/CD Pipeline</h3>
<ul>
<li>
<p><strong>Build Pipeline</strong>:</p>
</li>
<li>
<p>Set up GitHub Actions for automated testing</p>
</li>
<li>Implement linting and code quality checks</li>
<li>Add automatic Docker image building</li>
<li>
<p>Create semantic versioning workflow</p>
</li>
<li>
<p><strong>Deployment Pipeline</strong>:</p>
</li>
<li>Implement staging environment</li>
<li>Add automated deployment to staging on merge to develop</li>
<li>Create production deployment approval workflow</li>
<li>Add post-deployment verification steps</li>
<li>Implement automatic rollback on failure</li>
</ul>
<h2 id="examples">Examples:</h2>
<h3 id="1-conversationstore-interface-design_1">1. ConversationStore Interface Design</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># src/conversation/store/base_store.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">abc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ConversationStore</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for conversation storage implementations.&quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_conversation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load conversation history from storage.</span>

<span class="sd">        Args:</span>
<span class="sd">            conversation_id: Unique identifier for the conversation</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of message dictionaries in the format used by ConversationManager</span>

<span class="sd">        Raises:</span>
<span class="sd">            ConversationError: If loading fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save_conversation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Persist conversation to storage.</span>

<span class="sd">        Args:</span>
<span class="sd">            conversation_id: Unique identifier for the conversation</span>
<span class="sd">            messages: List of message dictionaries to store</span>

<span class="sd">        Raises:</span>
<span class="sd">            ConversationError: If saving fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_conversation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove conversation from storage.</span>

<span class="sd">        Args:</span>
<span class="sd">            conversation_id: Unique identifier for the conversation</span>

<span class="sd">        Raises:</span>
<span class="sd">            ConversationError: If deletion fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_conversations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List available conversation IDs.</span>

<span class="sd">        Args:</span>
<span class="sd">            limit: Maximum number of conversation IDs to return</span>
<span class="sd">            offset: Starting offset for pagination</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of conversation IDs</span>

<span class="sd">        Raises:</span>
<span class="sd">            ConversationError: If listing fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div>
<h3 id="2-fileconversationstore-implementation_1">2. FileConversationStore Implementation</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># src/conversation/store/file_store.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">aiofiles</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.base_store</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">...utils.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggerInterface</span><span class="p">,</span> <span class="n">LoggerFactory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">...exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationError</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FileConversationStore</span><span class="p">(</span><span class="n">ConversationStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;File-based implementation of ConversationStore using JSON files.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">storage_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./conversations&quot;</span><span class="p">,</span>
                 <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LoggerInterface</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the file-based conversation store.</span>

<span class="sd">        Args:</span>
<span class="sd">            storage_dir: Directory path to store conversation files</span>
<span class="sd">            logger: Logger instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage_dir</span> <span class="o">=</span> <span class="n">storage_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;file_conversation_store&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure storage directory exists</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_storage_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FileConversationStore initialized with storage dir: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_storage_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the file path for a conversation ID.&quot;&quot;&quot;</span>
        <span class="c1"># Sanitize conversation_id to prevent path traversal</span>
        <span class="n">safe_id</span> <span class="o">=</span> <span class="n">conversation_id</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_storage_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_id</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_conversation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load conversation from a JSON file.&quot;&quot;&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_file_path</span><span class="p">(</span><span class="n">conversation_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading conversation from </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conversation file not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="k">async</span> <span class="k">with</span> <span class="n">aiofiles</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error loading conversation </span><span class="si">{</span><span class="n">conversation_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConversationError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save_conversation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save conversation to a JSON file.&quot;&quot;&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_file_path</span><span class="p">(</span><span class="n">conversation_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving conversation to </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">aiofiles</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error saving conversation </span><span class="si">{</span><span class="n">conversation_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConversationError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_conversation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete conversation file.&quot;&quot;&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_file_path</span><span class="p">(</span><span class="n">conversation_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting conversation file: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error deleting conversation </span><span class="si">{</span><span class="n">conversation_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConversationError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_conversations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List all conversation IDs based on filenames.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Listing conversations (limit=</span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">, offset=</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_storage_dir</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_storage_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>

            <span class="c1"># Sort by modification time (newest first)</span>
            <span class="n">files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_storage_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Apply pagination</span>
            <span class="n">paginated_files</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">limit</span><span class="p">]</span>

            <span class="c1"># Remove .json extension to get IDs</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">paginated_files</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error listing conversations: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConversationError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div>
<h3 id="3-dynamodbconversationstore-implementation_1">3. DynamoDBConversationStore Implementation</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># src/conversation/store/dynamodb_store.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.base_store</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">...utils.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggerInterface</span><span class="p">,</span> <span class="n">LoggerFactory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">...exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">...config.unified_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnifiedConfig</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DynamoDBConversationStore</span><span class="p">(</span><span class="n">ConversationStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;DynamoDB-based implementation of ConversationStore with automatic compression.&quot;&quot;&quot;</span>

    <span class="c1"># DynamoDB item size limit in bytes</span>
    <span class="n">ITEM_SIZE_LIMIT</span> <span class="o">=</span> <span class="mi">400000</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">table_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">region_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">compression_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>  <span class="c1"># Compress if &gt; 100KB</span>
                 <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LoggerInterface</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the DynamoDB conversation store.</span>

<span class="sd">        Args:</span>
<span class="sd">            table_name: DynamoDB table name (or None to use config)</span>
<span class="sd">            region_name: AWS region (or None to use config)</span>
<span class="sd">            compression_threshold: Byte threshold for compressing data</span>
<span class="sd">            logger: Logger instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dynamodb_conversation_store&quot;</span><span class="p">)</span>

        <span class="c1"># Load configuration</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">UnifiedConfig</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
        <span class="n">dynamodb_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_config_section</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="c1"># Set table name and region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span> <span class="o">=</span> <span class="n">table_name</span> <span class="ow">or</span> <span class="n">dynamodb_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;conversation_table_name&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_region_name</span> <span class="o">=</span> <span class="n">region_name</span> <span class="ow">or</span> <span class="n">dynamodb_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;region_name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;us-east-1&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DynamoDB table name not provided and not found in configuration&quot;</span><span class="p">)</span>

        <span class="c1"># Compression settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compression_threshold</span> <span class="o">=</span> <span class="n">compression_threshold</span>

        <span class="c1"># Initialize DynamoDB client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_region_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DynamoDBConversationStore initialized with table: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_conversation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load conversation from DynamoDB.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading conversation from DynamoDB: </span><span class="si">{</span><span class="n">conversation_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;conversation_id&#39;</span><span class="p">:</span> <span class="n">conversation_id</span><span class="p">})</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conversation not found: </span><span class="si">{</span><span class="n">conversation_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="c1"># Check if the data is compressed</span>
            <span class="n">is_compressed</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compressed&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">messages_data</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">is_compressed</span><span class="p">:</span>
                <span class="c1"># Decompress the data</span>
                <span class="n">compressed_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">messages_data</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">decompressed_bytes</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">compressed_bytes</span><span class="p">)</span>
                <span class="n">messages_json</span> <span class="o">=</span> <span class="n">decompressed_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">messages_json</span> <span class="o">=</span> <span class="n">messages_data</span>

            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">messages_json</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error loading conversation </span><span class="si">{</span><span class="n">conversation_id</span><span class="si">}</span><span class="s2"> from DynamoDB: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConversationError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save_conversation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save conversation to DynamoDB with compression if needed.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving conversation to DynamoDB: </span><span class="si">{</span><span class="n">conversation_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Convert messages to JSON</span>
            <span class="n">messages_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">is_compressed</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Check if the size exceeds threshold for compression</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages_json</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compression_threshold</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compressing large conversation: </span><span class="si">{</span><span class="n">conversation_id</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">messages_json</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes)&quot;</span><span class="p">)</span>
                <span class="n">compressed_data</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">messages_json</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">messages_data</span> <span class="o">=</span> <span class="n">compressed_data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">is_compressed</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Check if still exceeds DynamoDB item size limit</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITEM_SIZE_LIMIT</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Compressed conversation size (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">messages_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes) exceeds DynamoDB limit&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ConversationError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">messages_data</span> <span class="o">=</span> <span class="n">messages_json</span>

            <span class="c1"># Save to DynamoDB</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span><span class="n">Item</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;conversation_id&#39;</span><span class="p">:</span> <span class="n">conversation_id</span><span class="p">,</span>
                <span class="s1">&#39;messages&#39;</span><span class="p">:</span> <span class="n">messages_data</span><span class="p">,</span>
                <span class="s1">&#39;compressed&#39;</span><span class="p">:</span> <span class="n">is_compressed</span><span class="p">,</span>
                <span class="s1">&#39;message_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">),</span>
                <span class="s1">&#39;last_updated&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error saving conversation </span><span class="si">{</span><span class="n">conversation_id</span><span class="si">}</span><span class="s2"> to DynamoDB: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConversationError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_conversation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete conversation from DynamoDB.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting conversation from DynamoDB: </span><span class="si">{</span><span class="n">conversation_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">delete_item</span><span class="p">(</span><span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;conversation_id&#39;</span><span class="p">:</span> <span class="n">conversation_id</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error deleting conversation </span><span class="si">{</span><span class="n">conversation_id</span><span class="si">}</span><span class="s2"> from DynamoDB: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConversationError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_conversations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List conversations from DynamoDB using scan operation.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Listing conversations from DynamoDB (limit=</span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">, offset=</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Note: DynamoDB scan with pagination is not ideal for large datasets</span>
            <span class="c1"># Consider implementing a GSI on last_updated if listing is frequently used</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
                <span class="n">ProjectionExpression</span><span class="o">=</span><span class="s2">&quot;conversation_id,last_updated&quot;</span><span class="p">,</span>
                <span class="n">Limit</span><span class="o">=</span><span class="n">limit</span> <span class="o">+</span> <span class="n">offset</span>
            <span class="p">)</span>

            <span class="n">items</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Items&#39;</span><span class="p">,</span> <span class="p">[])</span>

            <span class="c1"># Sort by last_updated (newest first)</span>
            <span class="n">items</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_updated&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Apply offset</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">offset</span><span class="p">:]</span>

            <span class="c1"># Apply limit</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">items</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>

            <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;conversation_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error listing conversations from DynamoDB: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConversationError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div>
<h3 id="4-conversationmanager-integration_1">4. ConversationManager Integration</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Enhanced src/conversation/conversation_manager.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggerInterface</span><span class="p">,</span> <span class="n">LoggerFactory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.response_parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResponseParser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..prompts.prompt_template</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptTemplate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.store.base_store</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationStore</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Message</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a message in a conversation.&quot;&quot;&quot;</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># Content can be a string or a list (for structured results like Anthropic tool results)</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">thoughts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Add tool_call_id for OpenAI compatibility if role is &#39;tool&#39;</span>
    <span class="n">tool_call_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ConversationManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages conversation history and state with persistent storage.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">conversation_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">store</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ConversationStore</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LoggerInterface</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the conversation manager.</span>

<span class="sd">        Args:</span>
<span class="sd">            conversation_id: Unique identifier for this conversation</span>
<span class="sd">            store: ConversationStore instance for persistence</span>
<span class="sd">            logger: Logger instance for logging operations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conversation_id</span> <span class="o">=</span> <span class="n">conversation_id</span> <span class="ow">or</span> <span class="s2">&quot;default&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="o">=</span> <span class="n">store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Message</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response_parser</span> <span class="o">=</span> <span class="n">ResponseParser</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized ConversationManager with ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_conversation_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using persistent store: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure conversation is loaded from storage if available.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">loaded_messages</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">load_conversation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conversation_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">loaded_messages</span><span class="p">:</span>
                    <span class="c1"># Convert loaded dict messages to Message objects</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">Message</span><span class="p">(</span>
                            <span class="n">role</span><span class="o">=</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">],</span>
                            <span class="n">content</span><span class="o">=</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                            <span class="n">thoughts</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thoughts&quot;</span><span class="p">),</span>
                            <span class="n">tool_call_id</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">loaded_messages</span>
                    <span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">)</span><span class="si">}</span><span class="s2"> messages from storage for conversation </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_conversation_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No existing messages found for conversation </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_conversation_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading conversation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># Continue with empty messages list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_save_to_store</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save conversation to persistent storage if available.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Convert Message objects to dictionaries</span>
                <span class="n">messages_dict</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
                        <span class="o">**</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">name</span><span class="p">}</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}),</span>
                        <span class="o">**</span><span class="p">({</span><span class="s2">&quot;thoughts&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">thoughts</span><span class="p">}</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">thoughts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}),</span>
                        <span class="o">**</span><span class="p">({</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">tool_call_id</span><span class="p">}</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">tool_call_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{})</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span>
                <span class="p">]</span>

                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">save_conversation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conversation_id</span><span class="p">,</span> <span class="n">messages_dict</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">)</span><span class="si">}</span><span class="s2"> messages to storage for conversation </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_conversation_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving conversation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
                   <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">extract_thoughts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="n">show_thinking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                   <span class="n">tool_call_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a message to the conversation history.</span>

<span class="sd">        Args:</span>
<span class="sd">            role: The role of the message sender (e.g., &#39;user&#39;, &#39;assistant&#39;, &#39;tool&#39;)</span>
<span class="sd">            content: The message content (string or list of dicts for structured messages)</span>
<span class="sd">            name: Optional name for the message (e.g., tool name)</span>
<span class="sd">            extract_thoughts: Whether to extract thoughts from the content (if string)</span>
<span class="sd">            show_thinking: Whether to include thoughts in the response content (if string)</span>
<span class="sd">            tool_call_id: Optional ID for tool messages (OpenAI)</span>
<span class="sd">            **kwargs: Additional message metadata (ignored for now)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure conversation is loaded</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_loaded</span><span class="p">()</span>

        <span class="n">thoughts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">processed_content</span> <span class="o">=</span> <span class="n">content</span>

        <span class="c1"># Only parse thoughts if content is string and role is assistant</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">extract_thoughts</span> <span class="ow">and</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;assistant&quot;</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_parser</span><span class="o">.</span><span class="n">parse_response</span><span class="p">(</span>
                <span class="n">content</span><span class="p">,</span>
                <span class="n">extract_thoughts</span><span class="o">=</span><span class="n">extract_thoughts</span><span class="p">,</span>
                <span class="n">show_thinking</span><span class="o">=</span><span class="n">show_thinking</span>
            <span class="p">)</span>
            <span class="n">processed_content</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
            <span class="n">thoughts</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thoughts&quot;</span><span class="p">)</span>

        <span class="c1"># Create the message object</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
            <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">processed_content</span><span class="p">,</span> <span class="c1"># Can be string or list</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">thoughts</span><span class="o">=</span><span class="n">thoughts</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="o">=</span><span class="n">tool_call_id</span> <span class="c1"># Store tool_call_id</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2"> message to conversation (Content type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">processed_content</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># Save to persistent storage</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_to_store</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">user_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">assistant_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">extract_thoughts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">show_thinking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a user-assistant interaction to the conversation.</span>

<span class="sd">        Args:</span>
<span class="sd">            user_message: The user&#39;s message</span>
<span class="sd">            assistant_message: The assistant&#39;s response</span>
<span class="sd">            extract_thoughts: Whether to extract thoughts from the assistant&#39;s response</span>
<span class="sd">            show_thinking: Whether to include thoughts in the response content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_message</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span>
            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">assistant_message</span><span class="p">,</span>
            <span class="n">extract_thoughts</span><span class="o">=</span><span class="n">extract_thoughts</span><span class="p">,</span>
            <span class="n">show_thinking</span><span class="o">=</span><span class="n">show_thinking</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added user-assistant interaction to conversation&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all messages in the conversation, formatted as dictionaries.</span>
<span class="sd">        Handles both string and list content.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of message dictionaries ready for most provider APIs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure conversation is loaded</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_loaded</span><span class="p">()</span>

        <span class="n">output_messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">:</span>
            <span class="n">message_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">content</span> <span class="c1"># Pass content directly (string or list)</span>
            <span class="p">}</span>
            <span class="c1"># Add optional fields if they exist</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                 <span class="n">message_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">tool_call_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                 <span class="n">message_dict</span><span class="p">[</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">tool_call_id</span>
            <span class="n">output_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_messages</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_last_message</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the last message in the conversation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The last message dictionary or None if no messages</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure conversation is loaded</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_loaded</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">last_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">last_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">last_msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">last_msg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;thoughts&quot;</span><span class="p">:</span> <span class="n">last_msg</span><span class="o">.</span><span class="n">thoughts</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">clear_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear all messages from the conversation.&quot;&quot;&quot;</span>
        <span class="c1"># Ensure conversation is loaded first</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_loaded</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cleared conversation messages&quot;</span><span class="p">)</span>

        <span class="c1"># Update persistent storage</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_to_store</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_conversation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete the conversation from persistent storage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">delete_conversation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conversation_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted conversation </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_conversation_id</span><span class="si">}</span><span class="s2"> from storage&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting conversation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<h2 id="phase-2-tooling-telegram-integration_1">Phase 2: Tooling &amp; Telegram Integration</h2>
<h3 id="1-telegram-bot-implementation">1. Telegram Bot Implementation</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># telegram_bot.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">telegram</span><span class="w"> </span><span class="kn">import</span> <span class="n">Update</span><span class="p">,</span> <span class="n">Bot</span><span class="p">,</span> <span class="n">Message</span> <span class="k">as</span> <span class="n">TelegramMessage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">telegram.ext</span><span class="w"> </span><span class="kn">import</span> <span class="n">Application</span><span class="p">,</span> <span class="n">CommandHandler</span><span class="p">,</span> <span class="n">MessageHandler</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">ContextTypes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.conversation.store.base_store</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.conversation.store.file_store</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileConversationStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.conversation.store.dynamodb_store</span><span class="w"> </span><span class="kn">import</span> <span class="n">DynamoDBConversationStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.config.unified_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnifiedConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.agents.coordinator</span><span class="w"> </span><span class="kn">import</span> <span class="n">Coordinator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.utils.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggerFactory</span><span class="p">,</span> <span class="n">LoggerInterface</span>

<span class="c1"># Configure logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
<span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TelegramBot</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Telegram bot integration for the Agentic-AI framework.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">conversation_store</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ConversationStore</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Telegram bot.</span>

<span class="sd">        Args:</span>
<span class="sd">            token: Telegram bot token</span>
<span class="sd">            conversation_store: ConversationStore implementation for persistence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">conversation_store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">UnifiedConfig</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;telegram_bot&quot;</span><span class="p">)</span>

        <span class="c1"># Create application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">Application</span><span class="o">.</span><span class="n">builder</span><span class="p">()</span><span class="o">.</span><span class="n">token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

        <span class="c1"># Setup handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_handlers</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Telegram bot initialized&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup command and message handlers.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_start</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_help</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_reset</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_message</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">VOICE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_voice</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_error_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the /start command.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="s2">&quot;Hello! I&#39;m your AI assistant. How can I help you today?&quot;</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the /help command.&quot;&quot;&quot;</span>
        <span class="n">help_text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;I&#39;m your personal AI assistant. You can:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;• Ask me questions</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;• Request tasks</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;• Send voice messages</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;• Use /reset to clear our conversation history&quot;</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">help_text</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the /reset command to clear conversation history.&quot;&quot;&quot;</span>
        <span class="n">chat_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Create a coordinator with the appropriate conversation_id</span>
        <span class="n">coordinator</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_coordinator</span><span class="p">(</span><span class="n">chat_id</span><span class="p">)</span>

        <span class="c1"># Clear conversation history</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">delete_conversation</span><span class="p">(</span><span class="n">chat_id</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;Conversation history has been reset.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error resetting conversation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;Sorry, I couldn&#39;t reset our conversation. Please try again.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;No persistent storage configured. Session-only conversation reset.&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle incoming text messages.&quot;&quot;&quot;</span>
        <span class="n">chat_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_message</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span>
        <span class="n">user_name</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">first_name</span>

        <span class="c1"># Log incoming message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received message from </span><span class="si">{</span><span class="n">user_name</span><span class="si">}</span><span class="s2"> (chat_id: </span><span class="si">{</span><span class="n">chat_id</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">user_message</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

        <span class="c1"># Notify user that processing is happening</span>
        <span class="n">typing_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;Thinking...&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create a coordinator with the appropriate conversation_id</span>
            <span class="n">coordinator</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_coordinator</span><span class="p">(</span><span class="n">chat_id</span><span class="p">)</span>

            <span class="c1"># Process the request</span>
            <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">user_message</span><span class="p">,</span>
                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;user_name&quot;</span><span class="p">:</span> <span class="n">user_name</span><span class="p">,</span>
                    <span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="s2">&quot;telegram&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;chat_id&quot;</span><span class="p">:</span> <span class="n">chat_id</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1"># Process the request (this will save conversation history via ConversationManager)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">coordinator</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

            <span class="c1"># Delete the &quot;Thinking...&quot; message</span>
            <span class="k">await</span> <span class="n">typing_message</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

            <span class="c1"># Send the response</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="s2">&quot;content&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;Sorry, I couldn&#39;t process your request.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">typing_message</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;Sorry, I encountered an error processing your request. Please try again.&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_voice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle incoming voice messages.&quot;&quot;&quot;</span>
        <span class="n">chat_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Notify user that processing is happening</span>
        <span class="n">processing_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;Processing audio...&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get voice file details</span>
            <span class="n">voice</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">voice</span>
            <span class="n">voice_file</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">voice</span><span class="o">.</span><span class="n">file_id</span><span class="p">)</span>

            <span class="c1"># Create temporary file path</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;temp_voice_</span><span class="si">{</span><span class="n">voice</span><span class="o">.</span><span class="n">file_id</span><span class="si">}</span><span class="s2">.ogg&quot;</span>

            <span class="c1"># Download voice file</span>
            <span class="k">await</span> <span class="n">voice_file</span><span class="o">.</span><span class="n">download_to_drive</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

            <span class="c1"># Create coordinator</span>
            <span class="n">coordinator</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_coordinator</span><span class="p">(</span><span class="n">chat_id</span><span class="p">)</span>

            <span class="c1"># Process as audio transcription request</span>
            <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;audio_transcription&quot;</span><span class="p">,</span>
                <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="n">file_path</span><span class="p">,</span>
                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;user_name&quot;</span><span class="p">:</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
                    <span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="s2">&quot;telegram&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;chat_id&quot;</span><span class="p">:</span> <span class="n">chat_id</span><span class="p">,</span>
                    <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">voice</span><span class="o">.</span><span class="n">duration</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1"># Process the request</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">coordinator</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

            <span class="c1"># Clean up the temporary file</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

            <span class="c1"># Delete processing message</span>
            <span class="k">await</span> <span class="n">processing_message</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

            <span class="c1"># Send the transcription</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="s2">&quot;content&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                <span class="c1"># First send the transcription</span>
                <span class="n">transcription</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;transcription&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">transcription</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🎤 *Transcription:*</span><span class="se">\n</span><span class="si">{</span><span class="n">transcription</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;Markdown&quot;</span><span class="p">)</span>

                <span class="c1"># Then send the AI response to the transcription</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;Sorry, I couldn&#39;t transcribe your audio message.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing voice message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">processing_message</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;Sorry, I encountered an error processing your voice message.&quot;</span><span class="p">)</span>
            <span class="c1"># Clean up the temporary file if it exists</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle errors in the telegram bot.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Update </span><span class="si">{</span><span class="n">update</span><span class="si">}</span><span class="s2"> caused error: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>

        <span class="c1"># Notify user of the error</span>
        <span class="k">if</span> <span class="n">update</span> <span class="ow">and</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span>
                <span class="n">chat_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Sorry, something went wrong. Please try again later.&quot;</span>
            <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_create_coordinator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Coordinator</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a coordinator instance with appropriate conversation store.</span>

<span class="sd">        Args:</span>
<span class="sd">            conversation_id: Unique identifier for the conversation</span>

<span class="sd">        Returns:</span>
<span class="sd">            Initialized Coordinator instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a logger for this coordinator</span>
        <span class="n">coordinator_logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;telegram_coordinator_</span><span class="si">{</span><span class="n">conversation_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create a coordinator with the conversation store</span>
        <span class="n">coordinator</span> <span class="o">=</span> <span class="n">Coordinator</span><span class="p">(</span>
            <span class="n">unified_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">coordinator_logger</span>
        <span class="p">)</span>

        <span class="c1"># Here we would initialize the ConversationManager with the store and conversation_id</span>
        <span class="c1"># This logic would need to be integrated into the BaseAgent and ToolEnabledAI classes</span>
        <span class="c1"># to pass the conversation_id and store to the ConversationManager</span>

        <span class="k">return</span> <span class="n">coordinator</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the bot until it&#39;s stopped.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Telegram bot&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">updater</span><span class="o">.</span><span class="n">start_polling</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Keep the bot running until Ctrl+C is pressed</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">updater</span><span class="o">.</span><span class="n">stop_on_signal</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Telegram bot stopped&quot;</span><span class="p">)</span>

<span class="c1"># Main entry point</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Set up configuration</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">UnifiedConfig</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>

    <span class="c1"># Get bot token from environment variable or config</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TELEGRAM_BOT_TOKEN&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">get_config_value</span><span class="p">(</span><span class="s2">&quot;telegram&quot;</span><span class="p">,</span> <span class="s2">&quot;bot_token&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Telegram bot token not found. Set TELEGRAM_BOT_TOKEN environment variable.&quot;</span><span class="p">)</span>

    <span class="c1"># Determine store type from config</span>
    <span class="n">store_type</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_config_value</span><span class="p">(</span><span class="s2">&quot;conversation&quot;</span><span class="p">,</span> <span class="s2">&quot;store_type&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>

    <span class="c1"># Create the appropriate store based on configuration</span>
    <span class="n">store</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">store_type</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
        <span class="n">store_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_config_value</span><span class="p">(</span><span class="s2">&quot;conversation&quot;</span><span class="p">,</span> <span class="s2">&quot;file_store_dir&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./conversations&quot;</span><span class="p">)</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">FileConversationStore</span><span class="p">(</span><span class="n">storage_dir</span><span class="o">=</span><span class="n">store_dir</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">store_type</span> <span class="o">==</span> <span class="s2">&quot;dynamodb&quot;</span><span class="p">:</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_config_value</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">,</span> <span class="s2">&quot;conversation_table_name&quot;</span><span class="p">)</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_config_value</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">,</span> <span class="s2">&quot;region_name&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;us-east-1&quot;</span><span class="p">)</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">DynamoDBConversationStore</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown store type: </span><span class="si">{</span><span class="n">store_type</span><span class="si">}</span><span class="s2">. Proceeding without persistent storage.&quot;</span><span class="p">)</span>

    <span class="c1"># Create and run the bot</span>
    <span class="n">bot</span> <span class="o">=</span> <span class="n">TelegramBot</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">conversation_store</span><span class="o">=</span><span class="n">store</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">bot</span><span class="o">.</span><span class="n">run</span><span class="p">())</span>
</code></pre></div>
<h3 id="2-mcp-integration">2. MCP Integration</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># src/mcp/mcp_config.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggerInterface</span><span class="p">,</span> <span class="n">LoggerFactory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigError</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MCPConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration manager for MCP (Multi-tool Command Protocol) integrations.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">config_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LoggerInterface</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize MCP configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            config_path: Path to MCP configuration YAML file</span>
<span class="sd">            logger: Logger instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;mcp_config&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_path</span> <span class="o">=</span> <span class="n">config_path</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MCP_CONFIG_PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;./mcp.yml&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Load configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_config</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load MCP configuration from YAML file.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MCP configuration file not found: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded MCP configuration from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Validate configuration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_config</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading MCP configuration: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load MCP configuration: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate MCP configuration structure.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span><span class="s2">&quot;Invalid MCP configuration format. Expected a dictionary.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;tools&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span><span class="s2">&quot;Missing &#39;tools&#39; section in MCP configuration.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;tools&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;tools&#39; section in MCP configuration. Expected a dictionary.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">tool_name</span><span class="p">,</span> <span class="n">tool_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;tools&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid configuration for tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39;. Expected a dictionary.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;url&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tool_config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing &#39;url&#39; for tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_tool_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get configuration for a specific MCP tool.</span>

<span class="sd">        Args:</span>
<span class="sd">            tool_name: Name of the tool</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tool configuration dictionary or None if not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tool_name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get configurations for all MCP tools.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary mapping tool names to their configurations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_global_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get global MCP configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Global configuration dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;tools&quot;</span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># src/mcp/mcp_tool.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..tools.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolDefinition</span><span class="p">,</span> <span class="n">ToolResult</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggerInterface</span><span class="p">,</span> <span class="n">LoggerFactory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolExecutionError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.mcp_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">MCPConfig</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MCPTool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Integration with external MCP tool endpoints.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MCPConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LoggerInterface</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize MCP tool integration.</span>

<span class="sd">        Args:</span>
<span class="sd">            tool_name: Name of the MCP tool</span>
<span class="sd">            config: MCP configuration instance</span>
<span class="sd">            logger: Logger instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tool_name</span> <span class="o">=</span> <span class="n">tool_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mcp_tool_</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">MCPConfig</span><span class="p">()</span>

        <span class="c1"># Get tool configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tool_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get_tool_config</span><span class="p">(</span><span class="n">tool_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tool_config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration for MCP tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tool_config</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tool_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tool_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>  <span class="c1"># Default timeout: 30 seconds</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized MCP tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; with URL: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the MCP tool.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs: Parameters for the tool execution</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tool execution result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing MCP tool &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_name</span><span class="si">}</span><span class="s2">&#39; with parameters: </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Prepare request payload</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">kwargs</span>
            <span class="p">}</span>

            <span class="c1"># Add request_id if provided</span>
            <span class="k">if</span> <span class="s2">&quot;request_id&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;request_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>

            <span class="c1"># Execute HTTP request</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span>
                    <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                    <span class="n">response_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

                    <span class="c1"># Check for errors in response</span>
                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
                        <span class="n">error_message</span> <span class="o">=</span> <span class="n">response_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;HTTP error </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MCP tool &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_name</span><span class="si">}</span><span class="s2">&#39; returned error: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">ToolResult</span><span class="p">(</span>
                            <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">error</span><span class="o">=</span><span class="n">error_message</span><span class="p">,</span>
                            <span class="n">tool_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_name</span>
                        <span class="p">)</span>

                    <span class="c1"># Process successful response</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">response_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">ToolResult</span><span class="p">(</span>
                        <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
                        <span class="n">tool_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_name</span>
                    <span class="p">)</span>
        <span class="k">except</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;HTTP client error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_message</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ToolResult</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="n">error_message</span><span class="p">,</span>
                <span class="n">tool_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_name</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid JSON response: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_message</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ToolResult</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="n">error_message</span><span class="p">,</span>
                <span class="n">tool_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_name</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_message</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ToolResult</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="n">error_message</span><span class="p">,</span>
                <span class="n">tool_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_name</span>
            <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_tool_definition</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                           <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MCPConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolDefinition</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get tool definition for MCP tool.</span>

<span class="sd">        Args:</span>
<span class="sd">            tool_name: Name of the MCP tool</span>
<span class="sd">            config: MCP configuration instance</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tool definition or None if not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mcp_tool_def_</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">MCPConfig</span><span class="p">()</span>

        <span class="n">tool_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_tool_config</span><span class="p">(</span><span class="n">tool_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_config</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration for MCP tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">ToolDefinition</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">tool_name</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">tool_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;MCP tool: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">tool_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameters&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">source</span><span class="o">=</span><span class="s2">&quot;mcp&quot;</span>  <span class="c1"># Mark as MCP tool</span>
        <span class="p">)</span>
</code></pre></div>
<h2 id="phase-3-deployment-operations-vm-focus_1">Phase 3: Deployment &amp; Operations (VM Focus)</h2>
<h3 id="1-dockerfile-for-core-service">1. Dockerfile for Core Service</h3>
<div class="highlight"><pre><span></span><code><span class="c"># Dockerfile</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9-slim</span>

<span class="c"># Set working directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="c"># Set environment variables</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">PYTHONDONTWRITEBYTECODE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nv">PYTHONUNBUFFERED</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nv">PYTHONPATH</span><span class="o">=</span>/app

<span class="c"># Install dependencies</span>
<span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span>.
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="c"># Copy application code</span>
<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.

<span class="c"># Create non-root user</span>
<span class="k">RUN</span><span class="w"> </span>useradd<span class="w"> </span>-m<span class="w"> </span>appuser<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>chown<span class="w"> </span>-R<span class="w"> </span>appuser:appuser<span class="w"> </span>/app<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/app/conversations<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>chown<span class="w"> </span>-R<span class="w"> </span>appuser:appuser<span class="w"> </span>/app/conversations
<span class="k">USER</span><span class="w"> </span><span class="s">appuser</span>

<span class="c"># Set entrypoint</span>
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;telegram_bot.py&quot;</span><span class="p">]</span>
</code></pre></div>
<h3 id="2-docker-compose-configuration">2. Docker Compose Configuration</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># docker-compose.yml</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3.8&quot;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">agentic-ai</span><span class="p">:</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "content.code.copy"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>